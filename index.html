// New elements for the auth section
const authElements = {
    authSection: document.getElementById('auth-section'),
    authEmail: document.getElementById('auth-email'),
    authPassword: document.getElementById('auth-password'),
    signInButton: document.getElementById('auth-sign-in'),
    signUpButton: document.getElementById('auth-sign-up'),
    saveButton: document.getElementById('save-button'),
};

// ... existing state and elements objects ...

// Add to your elements object
elements.saveButton = document.getElementById('save-button');

// New authentication functions
async function signIn() {
    const email = authElements.authEmail.value;
    const password = authElements.authPassword.value;
    const { user, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) console.error(error);
    else console.log('Signed in successfully!', user);
}

async function signUp() {
    const email = authElements.authEmail.value;
    const password = authElements.authPassword.value;
    const { user, error } = await supabase.auth.signUp({ email, password });
    if (error) console.error(error);
    else console.log('Signed up successfully! Please check your email for confirmation.', user);
}

// Function to generate a unique loading ID for the session
function generateLoadingId() {
    // This is a simple example. A more robust solution might use a UUID library.
    const uniqueString = state.games.map(g => `${g.id}${state.scores[g.id] || ''}`).join('');
    return btoa(uniqueString + Date.now()).substring(0, 20);
}

// New function to save data to Supabase
async function saveToDatabase() {
    const { data: { user } } = await supabase.auth.getSession();
    if (!user) {
        showMessage("Please log in to save your game.");
        return;
    }

    const loadingId = generateLoadingId();
    const recordsToInsert = state.games.map(game => {
        const score = state.scores[game.id];
        const [scoreA, scoreB] = score ? score.split(':').map(Number) : [null, null];

        return {
            user_id: user.id,
            loading_id: loadingId,
            game_number: game.id,
            team_a_players: JSON.stringify(game.doubleA),
            team_b_players: JSON.stringify(game.doubleB),
            team_a_result: scoreA,
            team_b_result: scoreB,
            resting_player: game.resting || null,
        };
    });

    const { data, error } = await supabase
        .from('padel_games')
        .insert(recordsToInsert);

    if (error) {
        showMessage("Error saving game to database: " + error.message);
    } else {
        showMessage("Game successfully saved to the database!");
    }
}

// Update the event listeners
window.onload = function() {
    // ... existing listeners ...
    authElements.signInButton.addEventListener('click', signIn);
    authElements.signUpButton.addEventListener('click', signUp);
    elements.saveButton.addEventListener('click', saveToDatabase);

    // Initial check for a user session
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            // User is logged in, hide auth section
            authElements.authSection.classList.add('hidden');
        }
    });

    // ... existing loadState logic ...
};

// You may also want to update the UI when the auth state changes
supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN') {
        authElements.authSection.classList.add('hidden');
    } else if (event === 'SIGNED_OUT') {
        authElements.authSection.classList.remove('hidden');
    }
});
