<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // Corrected line
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-section" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Log In
                </button>
                <div id="auth-error" class="mt-4 text-center text-red-500 text-sm hidden">
                    Invalid credentials.
                </div>
            </form>
        </div>
    </div>

    <div id="game-content" class="min-h-screen p-4 md:p-8 hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Padel Manager</h1>
            <button id="logoutButton" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none">
                Logout
            </button>
        </header>

        <section id="setupSection" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Setup</h2>
            <div class="mb-4">
                <label for="playerNames" class="block text-sm font-medium text-gray-700 mb-1">Enter Player Names (separated by comma)</label>
                <input type="text" id="playerNames" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <span class="block text-sm font-medium text-gray-700 mb-2">Number of players per game</span>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="num-players" value="4" checked class="form-radio text-blue-600">
                        <span class="ml-2">4</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="num-players" value="2" class="form-radio text-blue-600">
                        <span class="ml-2">2</span>
                    </label>
                </div>
            </div>
            <button id="generateButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Create Schedule
            </button>
        </section>

        <section id="gameContainer" class="hidden mt-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Current Schedule</h2>
            <div id="gameSchedule" class="space-y-4"></div>
            <div class="mt-6 flex justify-between">
                <button id="resetButton" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 focus:outline-none hidden">
                    Reset
                </button>
                <button id="exportButton" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none hidden">
                    Export
                </button>
            </div>
        </section>

        <section id="leaderboardSection" class="mt-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Leaderboard</h2>
            <ul id="leaderboardList" class="space-y-2"></ul>
        </section>
        
        <section id="historicalGamesSection" class="mt-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Historical Games</h2>
            <div id="historicalGamesList" class="space-y-4"></div>
        </section>
    </div>

    <div id="scoreModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Enter Scores</h3>
            <div class="space-y-2 mb-4">
                <div class="flex items-center space-x-2">
                    <span id="team1Names" class="font-medium text-blue-600"></span>
                    <input type="number" id="team1Score" class="w-16 text-center border rounded" min="0">
                </div>
                <div class="flex items-center space-x-2">
                    <span id="team2Names" class="font-medium text-red-600"></span>
                    <input type="number" id="team2Score" class="w-16 text-center border rounded" min="0">
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancelScoreButton" class="px-4 py-2 text-gray-600 rounded-md hover:bg-gray-200">Cancel</button>
                <button id="saveScoreButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    
    <script>
        const elements = {
            loginSection: document.getElementById('login-section'),
            gameContent: document.getElementById('game-content'),
            loginForm: document.getElementById('login-form'),
            authError: document.getElementById('auth-error'),
            playerNamesInput: document.getElementById('playerNames'),
            generateButton: document.getElementById('generateButton'),
            resetButton: document.getElementById('resetButton'),
            exportButton: document.getElementById('exportButton'),
            setupSection: document.getElementById('setupSection'),
            gameContainer: document.getElementById('gameContainer'),
            gameSchedule: document.getElementById('gameSchedule'),
            leaderboardList: document.getElementById('leaderboardList'),
            historicalGamesList: document.getElementById('historicalGamesList'),
            scoreModal: document.getElementById('scoreModal'),
            team1Names: document.getElementById('team1Names'),
            team2Names: document.getElementById('team2Names'),
            team1ScoreInput: document.getElementById('team1Score'),
            team2ScoreInput: document.getElementById('team2Score'),
            saveScoreButton: document.getElementById('saveScoreButton'),
            cancelScoreButton: document.getElementById('cancelScoreButton'),
            logoutButton: document.getElementById('logoutButton'),
        };

        const state = {
            players: [],
            numPlayers: 4,
            schedule: [],
            leaderboard: {},
            currentScheduleId: null
        };

        // --- Supabase Database Functions ---
        async function saveGameToSupabase(gameData) {
            const { data, error } = await supabase
                .from('games')
                .insert([gameData]);

            if (error) {
                console.error('Error saving game:', error);
                return false;
            }
            console.log('Game saved successfully:', data);
            return true;
        }

        async function createScheduleInSupabase() {
            const { data, error } = await supabase
                .from('schedules')
                .insert([{ created_at: new Date().toISOString() }])
                .select()
                .single();
            
            if (error) {
                console.error('Error creating schedule:', error);
                return null;
            }
            return data.id;
        }

        async function loadHistoricalGames() {
            const { data: games, error } = await supabase
                .from('games')
                .select(`
                    *,
                    schedule:schedule_id ( created_at )
                `)
                .order('schedule_id', { ascending: false });

            if (error) {
                console.error('Error loading historical games:', error);
                return;
            }

            elements.historicalGamesList.innerHTML = '';
            games.forEach(game => {
                const gameElement = document.createElement('div');
                gameElement.className = 'bg-gray-100 p-4 rounded-md shadow-sm';
                const createdDate = new Date(game.schedule.created_at).toLocaleString();
                gameElement.innerHTML = `
                    <p class="font-medium text-gray-900">Game on: ${createdDate}</p>
                    <p class="text-sm text-gray-600">${game.player_1} & ${game.player_2} vs. ${game.player_3} & ${game.player_4}</p>
                    <p class="text-sm font-bold mt-1">Score: ${game.score_team_1} - ${game.score_team_2}</p>
                `;
                elements.historicalGamesList.appendChild(gameElement);
            });
        }
        
        // --- Core Padel Logic (mostly unchanged) ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateSchedule() {
            if (state.players.length < state.numPlayers) {
                alert(`Please enter at least ${state.numPlayers} players.`);
                return [];
            }

            let games = [];
            let availablePlayers = [...state.players];
            shuffleArray(availablePlayers);

            while (availablePlayers.length >= state.numPlayers) {
                let team1, team2;
                if (state.numPlayers === 4) {
                    team1 = [availablePlayers.pop(), availablePlayers.pop()];
                    team2 = [availablePlayers.pop(), availablePlayers.pop()];
                    games.push({
                        team1: team1,
                        team2: team2,
                        score: null
                    });
                } else if (state.numPlayers === 2) {
                    team1 = [availablePlayers.pop()];
                    team2 = [availablePlayers.pop()];
                    games.push({
                        team1: team1,
                        team2: team2,
                        score: null
                    });
                }
            }
            return games;
        }

        function renderGameSchedule() {
            elements.gameSchedule.innerHTML = '';
            state.schedule.forEach((game, index) => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'flex justify-between items-center p-4 bg-gray-100 rounded-lg shadow-sm';
                
                const team1Players = game.team1.join(' & ');
                const team2Players = game.team2.join(' & ');
                
                const scoreText = game.score ? `${game.score.team1} - ${game.score.team2}` : 'Enter Score';
                
                gameDiv.innerHTML = `
                    <p class="text-gray-700">${team1Players} vs. ${team2Players}</p>
                    <button class="score-button px-4 py-2 rounded-md font-medium text-white transition-colors" data-game-index="${index}" style="background-color: ${game.score ? '#22c55e' : '#f59e0b'};">
                        ${scoreText}
                    </button>
                `;
                elements.gameSchedule.appendChild(gameDiv);
            });
        }
        
        function calculateLeaderboard() {
            state.leaderboard = {};
            state.players.forEach(player => state.leaderboard[player] = { wins: 0, losses: 0, points: 0 });

            state.schedule.forEach(game => {
                if (game.score) {
                    const team1Won = game.score.team1 > game.score.team2;
                    const team2Won = game.score.team2 > game.score.team1;
                    
                    if (team1Won) {
                        game.team1.forEach(player => { state.leaderboard[player].wins++; state.leaderboard[player].points += 3; });
                        game.team2.forEach(player => { state.leaderboard[player].losses++; });
                    } else if (team2Won) {
                        game.team2.forEach(player => { state.leaderboard[player].wins++; state.leaderboard[player].points += 3; });
                        game.team1.forEach(player => { state.leaderboard[player].losses++; });
                    }
                }
            });
        }

        function renderLeaderboard() {
            elements.leaderboardList.innerHTML = '';
            const sortedPlayers = Object.entries(state.leaderboard).sort(([, a], [, b]) => b.points - a.points);
            sortedPlayers.forEach(([player, stats]) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-md shadow-sm';
                li.innerHTML = `
                    <span class="font-medium">${player}</span>
                    <span class="text-sm text-gray-600">Wins: ${stats.wins}, Losses: ${stats.losses}, Points: ${stats.points}</span>
                `;
                elements.leaderboardList.appendChild(li);
            });
        }
        
        // --- Event Handlers ---
        async function handleGenerateButton() {
            const playerNames = elements.playerNamesInput.value.split(',').map(name => name.trim()).filter(name => name.length > 0);
            if (playerNames.length === 0) {
                alert("Please enter player names.");
                return;
            }
            state.players = playerNames;
            state.numPlayers = parseInt(document.querySelector('input[name="num-players"]:checked').value);
            state.schedule = generateSchedule();
            
            // Save schedule and games to Supabase
            state.currentScheduleId = await createScheduleInSupabase();
            if (state.currentScheduleId) {
                const gamesToSave = state.schedule.map(game => ({
                    schedule_id: state.currentScheduleId,
                    player_1: game.team1[0],
                    player_2: game.team1[1] || null,
                    player_3: game.team2[0],
                    player_4: game.team2[1] || null,
                }));

                const { error } = await supabase.from('games').insert(gamesToSave);
                if (error) {
                    console.error('Failed to save games to Supabase:', error);
                }
            }

            elements.setupSection.classList.add('hidden');
            elements.gameContainer.classList.remove('hidden');
            elements.resetButton.classList.remove('hidden');
            elements.exportButton.classList.remove('hidden');
            renderGameSchedule();
            calculateLeaderboard();
            renderLeaderboard();
        }

        function handleResetButton() {
            state.players = [];
            state.schedule = [];
            state.leaderboard = {};
            state.currentScheduleId = null;
            elements.playerNamesInput.value = '';
            elements.setupSection.classList.remove('hidden');
            elements.gameContainer.classList.add('hidden');
            elements.resetButton.classList.add('hidden');
            elements.exportButton.classList.add('hidden');
            elements.gameSchedule.innerHTML = '';
            elements.leaderboardList.innerHTML = '';
        }

        function handleExportButton() {
            // Functionality to export to CSV, etc. remains the same
            alert("Export functionality not yet implemented.");
        }

        function showScoreModal(gameIndex) {
            const game = state.schedule[gameIndex];
            elements.team1Names.textContent = game.team1.join(' & ');
            elements.team2Names.textContent = game.team2.join(' & ');
            
            elements.team1ScoreInput.value = game.score ? game.score.team1 : '';
            elements.team2ScoreInput.value = game.score ? game.score.team2 : '';
            
            elements.scoreModal.dataset.gameIndex = gameIndex;
            elements.scoreModal.classList.remove('hidden');
        }

        async function saveScore() {
            const gameIndex = elements.scoreModal.dataset.gameIndex;
            const game = state.schedule[gameIndex];
            const score1 = parseInt(elements.team1ScoreInput.value);
            const score2 = parseInt(elements.team2ScoreInput.value);

            if (isNaN(score1) || isNaN(score2)) {
                alert("Please enter valid scores.");
                return;
            }

            game.score = { team1: score1, team2: score2 };
            
            // Update the game in Supabase
            const { error } = await supabase
                .from('games')
                .update({ score_team_1: score1, score_team_2: score2 })
                .eq('schedule_id', state.currentScheduleId)
                .or(`player_1.eq.${game.team1[0]},player_3.eq.${game.team1[0]}`);

            if (error) {
                console.error('Error updating game score:', error);
            }

            renderGameSchedule();
            calculateLeaderboard();
            renderLeaderboard();
            elements.scoreModal.classList.add('hidden');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                elements.authError.textContent = error.message;
                elements.authError.classList.remove('hidden');
                console.error('Login failed:', error.message);
            } else {
                elements.loginSection.classList.add('hidden');
                elements.gameContent.classList.remove('hidden');
                loadHistoricalGames();
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                elements.loginSection.classList.remove('hidden');
                elements.gameContent.classList.add('hidden');
                handleResetButton();
            } else {
                console.error('Logout failed:', error.message);
            }
        }

        // --- Initialization and Event Listeners ---
        window.onload = async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                elements.loginSection.classList.add('hidden');
                elements.gameContent.classList.remove('hidden');
                loadHistoricalGames();
            }

            elements.loginForm.addEventListener('submit', handleLogin);
            elements.logoutButton.addEventListener('click', handleLogout);
            elements.generateButton.addEventListener('click', handleGenerateButton);
            elements.resetButton.addEventListener('click', handleResetButton);
            elements.exportButton.addEventListener('click', handleExportButton);
            elements.saveScoreButton.addEventListener('click', saveScore);
            elements.cancelScoreButton.addEventListener('click', () => elements.scoreModal.classList.add('hidden'));

            elements.gameSchedule.addEventListener('click', (e) => {
                if (e.target.classList.contains('score-button')) {
                    const index = e.target.dataset.gameIndex;
                    showScoreModal(index);
                }
            });
        };
    </script>
</body>
</html>
